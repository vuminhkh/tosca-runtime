tosca_definitions_version: tosca_simple_yaml_1_0_0_wd03

template_name: openstack-swarm-bootstrap-template
template_version: 1.0.0-SNAPSHOT
template_author: MKV

imports:
  - toscaruntime-bootstrap-type:*
  - openstack-provider-types:*

topology_template:
  description: Wordpress deployment template for openstack
  inputs:
    image:
      type: string
    flavor:
      type: string
    key_path:
      type: string
    key_pair_name:
      type: string
    login:
      type: string
    key_path:
      type: string
    security_group_names:
      type: list
      entry_schema:
        type: string
    external_network_name:
      type: string

  outputs:
    public_daemon_url:
      description: The URL to access the docker daemon
      value: { get_attribute: [ swarmManager, public_docker_url ] }
    daemon_url:
      description: The URL to access the docker daemon
      value: { get_attribute: [ swarmManager, docker_url ] }
    public_proxy_url:
      description: The public URL to access the proxy
      value: { get_attribute: [ proxy, public_proxy_url ] }
    proxy_url:
      description: The URL to access the proxy
      value: { get_attribute: [ proxy, proxy_url ] }
    network_id:
      description: The id of the openstack network that the host of docker daemon is connected to
      value: { get_attribute: [ privateNetwork, provider_resource_id ] }
    docker_network_id:
      description: The overlay network that is created so that containers that use the swarm daemon can talk to each other
      value: { get_attribute: [ swarmManager, docker_network_id ] }
    docker_network_name:
      description: The overlay network that is created so that containers that use the swarm daemon can talk to each other
      value: { get_attribute: [ swarmManager, docker_network_name ] }
    external_network_id:
      description: The id of the external network that the host of docker daemon is connected to
      value: { get_attribute: [ publicNetwork, provider_resource_id ] }

  node_templates:

    publicNetwork:
      type: com.toscaruntime.openstack.nodes.ExternalNetwork
      properties:
        network_name: { get_input: external_network_name}

    privateNetwork:
      type: com.toscaruntime.openstack.nodes.Network
      properties:
        network_name: "dockerDaemonNetwork"
        cidr: "192.168.1.0/24"

    managerMachine:
      type: com.toscaruntime.openstack.nodes.Compute
      properties:
        image: { get_input: image }
        flavor: { get_input: flavor }
        login: { get_input: login }
        key_pair_name: { get_input: key_pair_name }
        key_path: { get_input: key_path }
        security_group_names: { get_input: security_group_names }
        user_data: |
          #!/bin/sh
          sudo cp /etc/hosts /tmp/hosts
          echo 127.0.0.1 `hostname` | sudo tee /etc/hosts > /dev/null
          cat  /tmp/hosts | sudo tee -a /etc/hosts > /dev/null
      requirements:
        - network: privateNetwork
        - network: publicNetwork

    managerDaemon:
      type: com.toscaruntime.docker.nodes.DockerDaemon
      requirements:
        - host: managerMachine
        - discovery_service: consulServer

    proxy:
      type: com.toscaruntime.docker.nodes.ProxyWebApp
      requirements:
        - host: managerMachine
        - daemon: swarmManager

    consulServer:
      type: com.toscaruntime.consul.nodes.ConsulAgent
      properties:
        agent_mode: server
      requirements:
        - host: managerMachine

    swarmManager:
      type: com.toscaruntime.docker.nodes.SwarmManager
      requirements:
        - host: managerMachine
        - daemon: managerDaemon
        - discovery_service: consulServer

    swarmNodeMachine:
      type: com.toscaruntime.openstack.nodes.Compute
      properties:
        image: { get_input: image }
        flavor: { get_input: flavor }
        login: { get_input: login }
        key_pair_name: { get_input: key_pair_name }
        key_path: { get_input: key_path }
        security_group_names: { get_input: security_group_names }
        user_data: |
          #!/bin/sh
          sudo cp /etc/hosts /tmp/hosts
          echo 127.0.0.1 `hostname` | sudo tee /etc/hosts > /dev/null
          cat  /tmp/hosts | sudo tee -a /etc/hosts > /dev/null
      requirements:
        - network: privateNetwork
        - network: publicNetwork
      capabilities:
        scalable:
          properties:
            max_instances: 3
            min_instances: 1
            default_instances: 1

    swarmNodeDaemon:
      type: com.toscaruntime.docker.nodes.DockerDaemon
      requirements:
        - host: swarmNodeMachine
        - discovery_service: consulClient

    consulClient:
      type: com.toscaruntime.consul.nodes.ConsulAgent
      properties:
        agent_mode: client
      requirements:
        - host: swarmNodeMachine
        - formCluster: consulServer