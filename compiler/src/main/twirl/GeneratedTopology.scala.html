@import com.toscaruntime.compiler.runtime.{Deployment, Node, Value}
@import com.toscaruntime.compiler.util.CompilerUtil.escapeJavaIdentifier

@import com.toscaruntime.compiler.util.CompilerUtil
@(deployment: Deployment)

@instantiateInstance(node: Node) = {
@node.typeName @node.javaIdentifier = new @node.typeName @Html("();")
@Html("initializeInstance(" + node.javaIdentifier + ", \"" + node.name + "\", " + node.javaIdentifier + "Index, " +
        (if(node.parent.isDefined) node.parent.get.javaIdentifier else "null") + ", " +
        (if(node.host.isDefined) node.host.get.javaIdentifier else "null") + ");")
@node.children.map { child =>
  @instantiateInstances(child)
}
}

@generateCapabilityProperties(nodeName: String, capabilityName: String, capabilityProperties: Map[String, Value]) = {
@base.html.generateProperties(nodeName + "_capability_" + escapeJavaIdentifier(capabilityName), capabilityProperties)
@Html("capabilities_properties_" + nodeName + ".put(\"" + capabilityName + "\", properties_" + nodeName + "_capability_" + escapeJavaIdentifier(capabilityName) + ");")
}

@instantiateNode(node: Node) = {
@if(node.properties.nonEmpty) {
  @base.html.generateProperties(node.javaIdentifier, node.properties)
}
@if(node.capabilityProperties.nonEmpty) {
  @Html("java.util.Map<String, java.util.Map<String, Object>> capabilities_properties_" + node.javaIdentifier + " = new java.util.HashMap<>();")
  @{
    node.capabilityProperties.map {
      case (capabilityName, capabilityProperties) => generateCapabilityProperties(node.javaIdentifier, capabilityName, capabilityProperties)
    }
  }
}

@Html("initializeNode(\"" + node.name + "\", " +
        node.typeName + ".class, " +
        (if(node.parent.isDefined) "\"" + node.parent.get.name + "\"" else "null") + ", " +
        (if(node.host.isDefined) "\"" + node.host.get.name + "\"" else "null") + ", " +
        (if(node.properties.nonEmpty) "properties_" + node.javaIdentifier else "new java.util.HashMap<>()") + ", " +
        (if(node.capabilityProperties.nonEmpty) "capabilities_properties_" + node.javaIdentifier else "new java.util.HashMap<>()") + ");"
)
  @node.children.map { child =>
    @instantiateNode(child)
  }
}

  @instantiateInstances(node: Node) = {
  @Html("int " + node.javaIdentifier + "InstancesCount = " + "this.nodes.get(\"" + node.name + "\").getInstancesCount();")
  @Html("for (int ")@node.javaIdentifier@Html("Index = 1; ")@node.javaIdentifier@Html("Index <= " + node.javaIdentifier + "InstancesCount; ")@node.javaIdentifier@Html("Index++) {")
  @instantiateInstance(node)
  @Html("}")
}

public class Deployment extends com.toscaruntime.sdk.Deployment@Html("{")

public void initializeNodes@Html("() {")
  @deployment.roots.map { node =>
  @instantiateNode(node)
}

  @deployment.nodes.map { node =>
  @if(node.dependencies.nonEmpty) {
    @Html("setDependencies(") "@node.name", @node.dependencies.zipWithIndex.map { case (dependency, index) => "@dependency.name"@if(index < node.dependencies.size - 1) {
      ,
    }
    }@Html(");")
  }
}
  @Html("}")

public void postInitializeConfig@Html("() {")
  @Html("this.config.setTopologyResourcePath(this.config.getArtifactsPath().resolve(\"" + CompilerUtil.normalizeCSARName(deployment.topologyCsarName) + "\"));")
@Html("}")

  public void initializeRelationships@Html("() {")
@deployment.relationships.map { relationship =>
  @base.html.generateProperties("rel_" + relationship.source.javaIdentifier + "_" + relationship.target.javaIdentifier, relationship.properties)
  @Html("generateRelationships(")"@relationship.source.name", "@relationship.target.name", properties_rel_@{
  relationship.source.javaIdentifier
}_@{
  relationship.target.javaIdentifier
}, @Html(relationship.typeName + ".class);")
}
@Html("}")

  public void initializeRelationshipInstances@Html("() {")
@deployment.relationships.map { relationship =>
  @Html("generateRelationshipInstances(")"@relationship.source.name", "@relationship.target.name", @Html(relationship.typeName + ".class);")
}
@Html("}")

  public void initializeInstances@Html("() {")
@deployment.roots.map { node =>
  @instantiateInstances(node)
}
@Html("}")

@if(deployment.outputs.nonEmpty) {
  @Html("public java.util.Map<String, Object> getOutputs() {")
  @Html("java.util.Map<String, Object> outputs = new java.util.HashMap<>();")
  @deployment.outputs.map { output =>
    @Html("outputs.put(\"" + output._1 + "\", " + base.html.evaluateValue(output._2) + ");")
  }
  return outputs;
  @Html("}")
}
@Html("}")